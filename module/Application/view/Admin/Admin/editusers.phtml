<?php
$title = 'Gestion des utilisateurs';
$this->headTitle($title);

$this->headLink()->prependStylesheet($this->basePath() . '/css/bootstrap-editable.css');
$this->headLink()->prependStylesheet($this->basePath() . '/css/datatable.css');
?>

<ul class="breadcrumb">
	<li><a href="<?php echo $this->url('page') ?>">Accueil</a> <span class="divider">/</span></li>
    <li class="active"> Administration <span class="divider">/</span></li>
    <li class="active"> Gestion des utilisateurs </li>
</ul>

<!-- Help Modal -->
<div id="helpModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
	    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
	    <h3 id="myModalLabel">Aide</h3>
    </div>
    <div class="modal-body">
    	<p>Cette page vous permet en tant qu'administrateur de l'application de gérer l'ensemble des utilisateurs. 
    	Vous pouvez effectuer une recherche parmis tous les utilisateurs, puis modifier leur login, nom, email et rôle en cliquant directement dessus.
    	</p>
    	<p>
    	Les rôles possibles pour un utilisateur sont :
    	<dl class="dl-horizontal">
    		<dt>Rôle Visiteur</dt>
		    <dd>L'utilisateur est bloqué</dd>
		    <dt>Rôle Utilisateur</dt>
		    <dd>Permet de consulter la collection et les parcours</dd>
		    <dt>Rôle Collection</dt>
		    <dd>Permet (en plus) d'alimenter la collection</dd>
		    <dt>Rôle Parcours</dt>
		    <dd>Permet (en plus) d'éditer des parcours</dd>
		    <dt>Rôle Admin</dt>
		    <dd>Tous les droits</dd>
		</dl>
		</p>
    	<p>
    	Si un utilisateur a demandé un rôle et est toujours en attente, une bulle rouge apparaît sur la ligne correspondante.
    	</p>
    </div>
    <div class="modal-footer">
	    <button class="btn" data-dismiss="modal" aria-hidden="true">Retour</button>
    </div>
</div>

<div class="page-header">
    <h1><?php echo $this->escapeHtml($title); ?> 
    <small> <a href="#helpModal" data-toggle="modal"><i class="icon-info-sign"> </i></a></small> </h1>
    <div class="messageEditUsers"></div>
</div>

<div class="container-fluid">
    <div class="row-fluid">
        <div class="span12">
            <div>
                <table class="table table-striped table-bordered data">
                    <thead>
                        <tr>
                            <th>Login</th>
                            <th>Nom / Prenom</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5">En cours de téléchargement</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="confirmDiv" >
</div> 

<?php $this->inlineScript()->captureStart(); ?>
	var table;
	$(function() {
	
	    table = ResultSet.paginate(
	    	$('.data'),
			{
				"aoColumns": [
		           	           	null,
		           	           	null, 
		           	        	null,
		                     	null,
		                     	{ "bSortable": false  }
	           	           	 ],
	           	"iColumns": 5,
	           	"bAutoWidth": false,
				"bSortClasses":false,
	           	"bProcessing": true,
                "bServerSide": true,
                "sAjaxSource": "<?php echo $this->url("admin/gestion-users"); ?>",
				"fnDrawCallback": function () {
					$('.status').editable({
						source: [
	                    <?php foreach ($roles as $role) : ?>
									{value: <?php echo $role->getId();?>, text: '<?php echo $role->getRoleId();?>'},
	                    <?php endforeach; ?>
								],
		                success: function(e) {
						    notifications.decrement();
						}
					});
	
					$(".ResetPassword").popover({placement:'top', trigger:'hover'}); 
	
	                $('.text').editable({ 
	                	emptytext: "Vide",
		                success: function(e) {
						    var resp = jQuery.parseJSON(e);
															
							if(resp.success === true){
								//location.reload();
								$('.messageEditUsers').showInfos(resp.message, "success");
							} else {
								//location.reload();
								$('.messageEditUsers').showInfos(resp.error, "error");
							}
						}
	                 });
					 
	                $('td').on('click', '.refueRole', function(event) {
	                    var dateURL = $(this).attr('data-url');
						$.post( 
							dateURL,
							'',
							function() {
								$('.status').popover('hide').attr('data-original-title',"Demande refusée");
								table.fnDraw();
								notifications.decrement();
							}
						);
	                }); 

				}
			}
		);
		
		$(document).on( 'click', '.SupprimerUser', function(e){
			var dateURL = $(this).attr('data-url');
			var dateValue = $(this).attr('data-value');
			$('#confirmDiv').confirmModal({
				heading:'Confirmation',
				body:"Êtes-vous sûr de vouloir supprimer définitivement l'utilisateur : "+dateValue+" ?",
				callback: function() {
					$.post(
						dateURL,
						{ name: "supprimer" },
						function(e) {
							table.fnDraw();
							                                   
							var resp = jQuery.parseJSON(e);
															
							if(resp.success === true){
								//location.reload();
								$('.messageEditUsers').showInfos(resp.message, "success");
							} else {
								//location.reload();
								$('.messageEditUsers').showInfos(resp.error, "error");
							}
						}
					);
				}
			});   
		});
		
		$(document).on( 'click', '.ResetPassword', function(e){
			var dateURL = $(this).attr('data-url');
			var dateValue = $(this).attr('data-value');
			$('#confirmDiv').confirmModal({
				heading:'Confirmation',
				body:"Êtes-vous sûr de vouloir réinitialiser le mot de passe de l'utilisateur : "+dateValue+" ?<br/>Celui-ci obtiendra son nouveau mot de passe à l'adresse mail qu'il a indiqué.",
				callback: function() {
					$.post(
						dateURL,
						{ name: "password" },
						function(e) {
							table.fnDraw();
							                                   
							var resp = jQuery.parseJSON(e);
															
							if(resp.success === true){
								//location.reload();
								$('.messageEditUsers').showInfos(resp.message, "success");
							} else {
								//location.reload();
								$('.messageEditUsers').showInfos(resp.error, "error");
							}
						}
					);
				}
			});   
		});

	});
<?php
$this->inlineScript()->captureEnd();

$this->headScript()->appendFile($this->basePath() . '/js/bootstrap-editable.js');
$this->headScript()->appendFile($this->basePath() . '/js/bootstrap-confirm.js');
$this->headScript()->appendFile($this->basePath() . '/js/jquery.dataTables.js');
$this->headScript()->appendFile($this->basePath() . '/js/ResultSet.js');
?>
