<?php
$title = 'Les parcours';
$this->headTitle($title);
?>

<?php $this->headLink()->prependStylesheet($this->basePath() . '/css/bootstrap-editable.css'); ?>
<?php $this->headLink()->prependStylesheet($this->basePath() . '/css/datatable.css'); ?>
<?php $this->headLink()->prependStylesheet($this->basePath() . '/css/pillbox.css'); ?>

<!-- Help Modal -->
<div id="helpModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
	    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
	    <h3 id="myModalLabel">Aide : parcours</h3>
    </div>
    <div class="modal-body">
    	<p>
    	Vous êtes sur la page principale de consultation des parcours.
    	</p>
    	<p>
    	Chaque ligne représente un parcours. Cliquez sur le titre d'un parcours pour accéder à sa fiche détaillée.
    	</p>
    </div>
    <div class="modal-footer">
	    <button class="btn" data-dismiss="modal" aria-hidden="true">Retour</button>
    </div>
</div>

<div class="page-header row-fluid">
	<div class="span9">
		<h1><?php echo $this->escapeHtml($title); ?> 
	    <small> <a href="#helpModal" data-toggle="modal"><i class="icon-info-sign"> </i></a></small> </h1>
	</div>
	<?php if ($this->isAllowed('Parcours') === true) :?>
		<a href="<?php echo $this->url('parcours/ajouter') ;?>" class="btn btn-primary span3"><i class="icon-plus"></i> Ajouter un parcours</a>
	<?php endif; ?>
</div>

<div class="row-fluid">
    <div class="span12">
        <div>
            <table class="table table-striped table-bordered" id="data">
                <thead>
                    <tr>
                        <th>Titre</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="2">En cours de téléchargement</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<?php $this->headScript()->appendFile($this->basePath() . '/js/pillbox.js') ;?>
<?php $this->headScript()->appendFile($this->basePath() . '/js/dataTables.js') ;?>

<?php $this->inlineScript()->captureStart(); ?>
	var tableParcours;
	$(function() {
	
		$("#submit").click( function () {
			tableParcours.fnDraw();
			return false;
		});

	    tableParcours = ResultSet.paginate(
			{
	           	"aoColumns": [
		           	           	null,
		           	           	null
	           	           	 ],
	           	"iColumns": 2,
	           	//"bAutoWidth": false,
				"bSortClasses":false,
	           	"bProcessing": true,
                "bServerSide": true,
                "sAjaxSource": "<?php echo $this->url("parcours"); ?>",
    			"fnServerData": function ( sSource, aoData, fnCallback, oSettings ) {
    				
    				var data = new Array();
    				
    				<?php if(isset($js_table)){ echo $js_table; }  ?>
    				
    				jQuery.each($('#form-pillbox').pillbox('items'), function() {
						var item =  new Object();
						item["type"] = this.type;
						item["value"] = this.value;
		
						data.push(item);
						
						if(typeof(this.context) != 'undefined' && this.type != 'type' ){
							if(!isDuplicate( 'type', this.context, aoData )){
								var obj =  new Object();
								obj["type"] = 'type';
								obj["value"] = this.context;
								data.push(obj);
							}
						}
					});

    				if (data.length > 0) {
						aoData.push( { "name": "conditions", "value": JSON.stringify(data) } );
					}

      				oSettings.jqXHR = $.ajax( {
	        			"dataType": 'json',
	        			"type": "POST",
	        			"url": sSource,
	        			"data": aoData,
	        			"success": fnCallback
	     			});
	     		},
	     		"fnDrawCallback": function(oSettings, json){
	     			$(".href-type-element").unbind("click").bind("click", function(e) {
						window.open($(this).attr("href"), "_blank");
						e.preventDefault();
					});
	     		}
			}
		);
		
	    // INITIALIZING PILLBOX
		$('.form-button').click(function () {
			var value = $.trim($(this).attr("data-value"));
			var type = $(this).attr("data-type");
			if(!isDuplicate( type, value )){
				$('#form-pillbox ul').append('<li class="status-success" data-type="' + type + '" data-value="' + value + '" >' + $(this).attr("value") + '</li>');
			}
		});	
		
		$('.form-plus-type').click(function () {
			var el = $(this).parent().find('.form-type > option:selected')
			var type = el.attr("data-type");
			var value = el.attr("data-value");
			
			if(!isDuplicate( type, value )){
				var context = el.parent().children('.type-all').attr("data-value");
				var icon;
				var color;
				if (context == 'artefact') {
					icon = '<i class="icon-tag"> </i>';
					color = 'status-success';
				} else {
					icon = '<i class="icon-picture"> </i>';
					color = 'status-warning';
				}
				
				if( el.hasClass('type-all') ){
					$('#form-pillbox ul > li[data-context="' + context + '"]').remove();
					$('#form-pillbox ul').append('<li class="' + color + ' type-all" data-type="' + type + '" data-value="' + value + '" data-context="' + context + '" >' + icon + ' ' + el.val() + '</li>');
				} else {
					$('#form-pillbox ul > li[data-context="' + context + '"].type-all ').remove();
					$('#form-pillbox ul').append('<li class="' + color + '" data-type="' + type + '" data-value="' + value + '" data-context="' + context + '" >' + icon + ' ' + el.val() + '</li>');
				}
			}

			$(this).parent().children('.form-type').prop('selectedIndex',0);

		});	
		
		$('.form-plus-titre').click(function () {
			var e = jQuery.Event("keypress");
			e.which = 13; // Code touche entr�e = 13
			$(this).parent().children('.form-titre').trigger(e);
		});	

		$('.form-titre').keypress(function(event){
			var value = $.trim($(this).attr("value"));
			var type = $(this).attr("data-type");
			if( event.which == 13 && value != "" ){ // Code touche entr�e = 13
				$(this).attr("data-value", value);
				if(!isDuplicate( type, value )){
					$('#form-pillbox ul').append('<li class="status-info" data-type="' + type + '" data-value="' + value + '">' + '"' + value + '"' + '</li>');
				}
				$(this).attr("value", "");
				$(this).attr("data-value", "");
				event.preventDefault();
			}
		});

		$('.form-clear').click(function () {
			$('.form-titre').attr("value", "").attr("data-value", "");
			$('.form-type').prop('selectedIndex',0);
			$('#form-pillbox ul > li').remove();
			return false;
		});

		function isDuplicate(type, value, array){
			var array = ( typeof(array) == 'undefined' ? $('#form-pillbox').pillbox('items') : array );
			var duplicate = false;
			jQuery.each(array, function() {
				if(this.value == value && this.type == type){
					duplicate = true;
					return;
				}
			});
			return duplicate;
		}
		
		String.prototype.ucFirst = function() {
		    return this.charAt(0).toUpperCase() + this.slice(1);
		}

	});
<?php $this->inlineScript()->captureEnd(); ?>