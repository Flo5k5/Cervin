<?php
$title = $Parcours->titre;
$this->headTitle($title);

$this->headLink()->prependStylesheet($this->basePath() . '/css/bootstrap-editable.css');
?>

<ul class="breadcrumb">
	<li><a href="<?php echo $this->url('page') ?>"> Accueil </a> <span class="divider">/</span></li>
    <li><a href="<?php echo $this->url('parcours') ?>">Parcours</a> <span class="divider">/</span></li>
    <li class="active"><i class="icon-road"></i> <?php echo $this->escapeHtml($title); ?></li>
</ul>

<!-- Help Modal -->
<div id="helpModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
	    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
	    <h3 id="myModalLabel">Aide</h3>
    </div>
    <div class="modal-body">
    	<p>
    	Vous êtes sur la page d'accueil d'un parcours. La graphe représente le parcours dans se globalité : 
    	<ul>
    	<li> En bleu le chemin recommandé</li>
    	<li>En gris les chemins secondaires</li>
    	<li> En rouge les scène sans transition entrante : attention elles ne sont pas accessibles</li>
    	</ul>
    	</p>
    	<p>
    	Le menu à gauche détaille les sous-parcours. Si vous avez l'autorisation, vous pouvez créer/supprimer des sous-parcours et ajouter de nouvelles scènes dans un sous-parcours.
    	</p>
    	<p>
    	Pour voir le détail d'une scène, cliquez dessus dans le graphe. Toute modification du parcours (modifier le contenu d'une scène, créer/supprimer/modifier une transition, ...) se fait en allant dans le détail de la scène concernée.
    	</p>
    </div>
    <div class="modal-footer">
	    <button class="btn" data-dismiss="modal" aria-hidden="true">Retour</button>
    </div>
</div>

<div class="page-header">
    <?php if ($this->isAllowed('Parcours') === true) :?>
    <h1>
    <i class="icon-road"></i> 
    <span class="edit CursorPointer"
                        data-url="<?php echo $this->url("parcours/modifier", array("id" => $Parcours->id)); ?>"
                        data-name="titre" 
                        data-type="text" 
                        data-inputclass="span10" 
                        data-pk="1"><?php echo $this->escapeHtml($title); ?></span>
    <small> <a href="#helpModal" data-toggle="modal"><i class="icon-info-sign"> </i></a></small> 
    </h1>
    <p class="edit CursorPointer"
                        data-url="<?php echo $this->url("parcours/modifier", array("id" => $Parcours->id)); ?>"
                        data-inputclass="span10" 
                        data-name="description" 
                        data-type="textarea" 
                        data-pk="1"><?php echo $this->escapeHtml($Parcours->description);?></p>
    <?php else : ?>
        <h1>
        <i class="icon-road"></i><?php echo $this->escapeHtml($title); ?>
    	<small> <a href="#helpModal" data-toggle="modal"><i class="icon-info-sign"> </i></a></small> 
    	</h1>
    	<p><?php echo $this->escapeHtml($Parcours->description);?></p>
    <?php endif;?>
</div>

<style type="text/css">

	.elements {
		width: 208px;
		text-align: center;
		padding: 20px 10px 20px 10px;
	} 
	
	a [class^="icon-"],a [class*=" icon-"],a [class^="icon-"]:before,a [class*=" icon-"]:before
	{
		display: inline-block;
	}
	
	.sous_parcours {
		border-style: dashed;
		border-width: 3px;
		border-color: #5B7244;
		padding: 5px 5px 20px 5px;
	}
  a {
    cursor: pointer;
  }


</style>

<script type="text/vnd.graphviz" id="cluster">

//<!--
digraph "<?php echo $Parcours->titre; ?>" { 
graph [bgcolor="#f3f3f3"];
<?php echo $dot ; ?>}
//-->

</script>

<?php
$this->headScript()->appendFile($this->basePath() . '/js/viz.js');
$this->headScript()->appendFile($this->basePath() . '/js/jquery.panzoom.js');
?>
<div class="row-fluid">


	<!-- Sous-parcours -->
	<div class="span4">
	<?php if ($this->isAllowed('Parcours') === true) :?>
		<div class="accordion" id="accordion2">
		<?php $sous_parcours = $Parcours->sous_parcours_depart; ?>
		<?php while ($sous_parcours != null) : ?>
			<div class="accordion-group">
				<div class="accordion-heading" >
					<a class="accordion-toggle" id="heading<?php echo $sous_parcours->id;?>" data-toggle="collapse" data-parent="#accordion2" href="#<?php echo $sous_parcours->id; ?>">
			            <h4><?php echo $this->escapeHtml($sous_parcours->titre); ?></h4>
					</a>
				</div>
				<div id="<?php echo $sous_parcours->id; ?>" class="accordion-body collapse">
					<div class="accordion-inner">
						<p class="edit CursorPointer"
				        	data-url="<?php echo $this->url("parcours/editSousParcours",array('idsp'=>$sous_parcours->id)) ?>"
				            data-name="titre" 
				            data-type="text"
				            data-pk="heading<?php echo $sous_parcours->id; ?>">
				            <?php echo $this->escapeHtml($sous_parcours->titre); ?>
				        </p>
						<a href="<?php echo $this->url('scene/creerSceneSecondaire', array("idsp" => $sous_parcours->id)) ?>"
		                	class="btn btn-primary btn-block">
		                    	<i class="icon-plus"></i> Ajouter une scène
		                </a>
						<a href="<?php echo $this->url('parcours/ajouterSousParcours', array("type" => "ajAvant", "idsp" => $sous_parcours->id)) ?>"
							class="btn btn-primary btn-block">
		                    	<i class="icon-mail-reply"></i> Ajouter un sous-parcours avant
		                </a>
		                <a href="<?php echo $this->url('parcours/ajouterSousParcours', array("type" => "ajApres", "idsp" => $sous_parcours->id)) ?>"
		                	class="btn btn-primary btn-block">
		                    	<i class="icon-mail-forward icon-rotate-180"></i> Ajouter un sous-parcours après
		                </a>
		                <a href="#" 
		                	data-url="<?php echo $this->url('parcours/supprimerSousParcours', array("idsp" => $sous_parcours->id)) ?>"
		                	class="btn btn-danger btn-block supprimerSousParcours">
		                    	<i class="icon-trash"></i> Supprimer le sous-parcours
		                </a>
					</div>
				</div>
			</div>
		<?php $sous_parcours = $sous_parcours->sous_parcours_suivant;
		endwhile; ?>
		</div>

	<?php else : ?>
		<h3>Sous-parcours : </h3>
		<hr/>
		<?php $sous_parcours = $Parcours->sous_parcours_depart; ?>
		<?php while ($sous_parcours != null) : ?>
		<h4><?php echo $this->escapeHtml($sous_parcours->titre); ?></h4>
		<?php $sous_parcours = $sous_parcours->sous_parcours_suivant;
		endwhile; ?>
	<?php endif; ?>
	</div>
	
	<div class="span8">
		<div class="btn-group">
		  <button class="zoom-out btn btn-primary"><i class="icon-minus-sign"></i></button>
		  <button class="zoom-in btn btn-primary"><i class="icon-plus-sign"></i></button>
		  <!-- <input type="range" class="zoom-range"> -->
		  <button class="reset btn btn-primary"><i class="icon-fullscreen"></i></button>
		  <button class="btn btn-primary refresh"><i class="icon-refresh"></i></button>
		</div>
		<!-- Graphe -->
		<div style="overflow: hidden; position: relative; border:3px solid black;"> 
		
			<div id="panzoom" style="text-align: center; height: 1000px">
			</div>
		</div>
	</div>

</div>

<div id="confirmDiv"></div>

<script>
    // https://github.com/timmywil/jquery.panzoom
      $("#panzoom").panzoom({
        $zoomIn: $(".zoom-in"),
        $zoomOut: $(".zoom-out"),
        $zoomRange: $(".zoom-range"),
        $reset: $(".reset")
      });
      
      function inspect(s) {
        return "<pre>" + s.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\"/g, "&quot;") + "</pre>"
      }
      
      function src(id) {
        return document.getElementById(id).innerHTML;
      }
      
      function example(id, format) {
        var result;
        try {
          result = Viz(src(id), format);
          if (format === "svg")
            return result;
          else
            return inspect(result);
        } catch(e) {
          return inspect(e.toString());
        }
      }
      $('#panzoom').html(example("cluster", "svg"));
      //document.body.innerHTML += example("cluster", "svg");

 </script>

<?php
$this->headScript()->appendFile($this->basePath() . '/js/bootstrap-editable.js');
$this->headScript()->appendFile($this->basePath() . '/js/bootstrap-confirm.js');
?>

<?php $this->inlineScript()->captureStart(); ?>

$('.edit').editable({
	emptytext: 'Vide', mode: 'inline'
});

$('.edit').on('save', function(e, params) {
	$('#'+$(this).attr('data-pk')).html('<h4>'+params.newValue+'</h4>');
});

// Suppression d'un sous-parcours
$(".supprimerSousParcours").click(function(e){
	var dataURL = $(this).attr('data-url');
	$('#confirmDiv').confirmModal({
	    heading:'Confirmation',
	    body:
	    	"<p class='lead'>Êtes-vous sûr de vouloir supprimer définitivement ce sous-parcours ?</p>" + 
	    	"<p class='muted'>Un sous-parcours ne peut être supprimé que lorsqu'il ne contient qu'une seule scène et qu'il n'est pas le seul sous-parcours du parcours.</p>" +
	    	"<p class='muted'>Si ce n'est pas le cas, la suppression n'aura pas lieu, commencez par vider le contenu du sous-parcours.</p>",
	    callback: function() {
	    	$('body').css('cursor', 'wait');
	       	$.post(
	            dataURL,
	           	function(response) {
			        document.location.reload();
			    }
	        );
	    }
	});
});

$(".refresh").click(function(e){
	document.location.reload();
});

<?php $this->inlineScript()->captureEnd();?>
