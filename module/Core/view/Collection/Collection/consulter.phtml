<?php
$title = 'La collection num√©rique';
$this->headTitle($title);
?>

<?php $this->headLink()->prependStylesheet($this->basePath() . '/css/bootstrap-editable.css'); ?>
<?php $this->headLink()->prependStylesheet($this->basePath() . '/css/datatable.css'); ?>
<?php $this->headLink()->prependStylesheet($this->basePath() . '/css/pillbox.css'); ?>

<div class="page-header">
    <h1><?php echo $this->escapeHtml($title); ?> <!-- <small>Subtext for header</small> --></h1>
</div>

<div class="container-fluid">
	<div class="row-fluid">
		<a href="<?php echo $this->url('artefact/ajouter') ?>" class="btn icon-plus btn-primary">Ajouter un artefact</a>
		<a href="<?php echo $this->url('media/ajouter') ?>" class="btn icon-plus btn-primary">Ajouter un m√©dia</a>
		<br/><br/>
		<div class="well">
		
			<form id="form-multi" name="form-multi" class="">
			
				<label>Recherche</label>
				
				<div class="input-append">
					<input class="form-titre" type="text" placeholder="Titre" data-type="titre" />
					<button class="btn form-plus" type="button"><i class="icon-plus"> </i></button>
					<!--<button id="form-switch-titre" class="btn" type="button"><i class="icon-refresh"> </i></button>-->
				</div>
	
				<div>
					<input type="button" class="btn form-button" data-type="type" data-value="artefact" value="Artefact" />
					<input type="button" class="btn form-button" data-type="type" data-value="media" value="M√©dia" />
				</div>
	
				<br/>
				
				<div>
				
					<div id="form-pillbox" class="pillbox">
						<ul>
						</ul>
					</div>

				</div>
				
				<button id="submit" class="btn">Rechercher</button>
				
			</form>
			
		</div>
	</div>
    <div class="row-fluid">
        <div class="span12">
            <div>
                <table class="table table-striped table-bordered" id="data">
                    <thead>
                        <tr>
                            <th>Titre</th>
                            <th>Description</th>
                            <th>Type</th>
                            <th>A/M</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="4">En cours de t√©l√©chargement</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<a href="<?php echo $this->url('artefact/ajouter') ?>" class="btn icon-plus btn-primary">Ajouter un artefact</a>
<a href="<?php echo $this->url('media/ajouter') ?>" class="btn icon-plus btn-primary">Ajouter un m√©dia</a>

<?php $this->headScript()->appendFile($this->basePath() . '/js/pillbox.js') ;?>
<?php $this->headScript()->appendFile($this->basePath() . '/js/dataTables.js') ;?>


<script type="text/javascript">
	//$(function() {

		$("#submit").click( function () {

			var data = new Array();

			jQuery.each($('#form-pillbox').pillbox('items'), function() {
				var item =  new Object();
				item["type"] = this.type;
				item["value"] = this.value;
				data.push(item);
			});

			var request = $.ajax({
				url: "<?php echo $this->url("collection/consulter"); ?>",
				type: "POST",
				data: {"conditions" : data},
				dataType: "html"
			});
					 
			request.done(function(msg) {
				var obj = jQuery.parseJSON(msg);
				aaData = obj.aaData;
				ResultSet.paginate({"bDestroy":true, "aaData": aaData});
			});
				
			return false;
		});

		var aaData = <?php echo $aaData; ?>;
	    var table = ResultSet.paginate(
			{
				"aaData": aaData,
	           	"aoColumns": [
		           	           	null,
		           	           	null, 
		           	        	{ "bSortable": false  },
		                     	{ "bSortable": false  }
	           	           	 ],
	           	"iColumns": 4
			}
		);

	    // INITIALIZING PILLBOX
		$('.form-button').click(function () {
			if(!isDuplicatePill( $(this) )){
				$('#form-pillbox ul').append('<li class="status-success" data-type="' + $(this).attr("data-type") + '" data-value="' + $(this).attr("data-value") + '">' + $(this).attr("value") + '</li>');
			}
		});	
		
		$('.form-plus').click(function () {
			var e = jQuery.Event("keypress");
			e.which = 13; // Code touche entrÈe = 13
			$(this).parent().children('.form-titre').trigger(e);
		});	

		$('.form-titre').keypress(function(event){
			var value = $(this).attr("value").trim();
			if( event.which == 13 && value != "" ){ // Code touche entrÈe = 13
				$(this).attr("data-value", value);
				if(!isDuplicatePill( $(this) )){
					$('#form-pillbox ul').append('<li class="status-success" data-type="' + $(this).attr("data-type") + '" data-value="' + $(this).attr("data-value") + '">' + value + '</li>');
				}
				$(this).attr("value", "");
				$(this).attr("data-value", "");
				event.preventDefault();
			}
		});
		
		function isDuplicatePill(el){
			var duplicate = false;
			jQuery.each($('#form-pillbox').pillbox('items'), function() {
				if(this.value === $(el).attr("data-value") && this.type === $(el).attr("data-type")){
					duplicate = true;
					return;
				}
			});
			return duplicate;
		}

		/*$('#form-switch-titre').click(function () {
			$('#form-titre').attr('placeholder', 'Titre et description');
		});*/
		
	//});
</script>
