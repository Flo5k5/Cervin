<?php
$title = 'La collection numérique';
$this->headTitle($title);
?>

<?php $this->headLink()->prependStylesheet($this->basePath() . '/css/bootstrap-editable.css'); ?>
<?php $this->headLink()->prependStylesheet($this->basePath() . '/css/datatable.css'); ?>
<?php $this->headLink()->prependStylesheet($this->basePath() . '/css/pillbox.css'); ?>

<div class="page-header">
    <h1><?php echo $this->escapeHtml($title); ?> <!-- <small>Subtext for header</small> --></h1>
</div>

<div class="container-fluid">
	<div class="row-fluid">
		<form id="form-multi" name="form-multi" class="">
			<br/>
			<div class="input-append">
				<input class="form-titre" type="text" placeholder="Titre" data-type="titre" />
				<button class="btn" type="button"><i class="icon-plus"> </i></button>
				<!--<button id="form-switch-titre" class="btn" type="button"><i class="icon-refresh"> </i></button>-->
			</div>

			<div>
				<input type="button" class="btn form-button" data-type="type" data-value="artefact" value="Artefact" />
				<input type="button" class="btn form-button" data-type="type" data-value="media" value="Média" />
			</div>

			<br/>
			<div>
				<div id="form-pillbox" class="pillbox">
					<ul>
					</ul>
				</div>

				<input type="button" class="btn btn-mini" id="btnItems" value="log items to console">
			</div>
			<br/>
			<button id="submit" class="btn">Rechercher</button>
			
			
		</form>
	</div>
    <div class="row-fluid">
        <div class="span12">
            <div>
                <table class="table table-striped table-bordered" id="data">
                    <thead>
                        <tr>
                            <th>Titre</th>
                            <th>Description</th>
                            <th>Type</th>
                            <th>A/M</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="4">En cours de téléchargement</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<a href="<?php echo $this->url('artefact/ajouter') ?>" class="btn icon-plus btn-primary">Ajouter un artefact</a>
<a href="<?php echo $this->url('media/ajouter') ?>" class="btn icon-plus btn-primary">Ajouter un média</a>

<?php $this->headScript()->appendFile($this->basePath() . '/js/pillbox.js') ;?>
<?php $this->headScript()->appendFile($this->basePath() . '/js/dataTables.js') ;?>


<script type="text/javascript">
	//$(function() {

		$("#submit").click( function () {

			var data = new Array();

			jQuery.each($('#form-pillbox').pillbox('items'), function() {
				var item =  new Object();
				item["type"] = this.type;
				item["value"] = this.value;
				data.push(item);
			});

			var request = $.ajax({
				url: "<?php echo $this->url("collection/consulter"); ?>",
				type: "POST",
				data: {"conditions" : data},
				dataType: "html"
			});
					 
			request.done(function(msg) {
				var obj = jQuery.parseJSON(msg);
				aaData = obj.aaData;
				ResultSet.paginate({"bDestroy":true, "aaData": aaData});
			});
				
			return false;
		});

		var aaData = <?php echo $aaData; ?>;
	    var table = ResultSet.paginate(
			{
				"aaData": aaData,
	           	"aoColumns": [
		           	           	null,
		           	           	null, 
		           	        	{ "bSortable": false  },
		                     	{ "bSortable": false  }
	           	           	 ],
	           	"iColumns": 4
			}
		);

	    // INITIALIZING PILLBOX
		$('#btnAdd').click(function () {
			$('#form-pillbox ul').append('<li>Item Eight</li>');
		});

		$('#btnRemove').click(function () {
			$('#form-pillbox li[data-value="foo"]').remove();
		});

		$('#btnItems').click(function () {
			var items = $('#form-pillbox').pillbox('items');
			console.log(items);
		});
		
		$('.form-button').click(function () {
			if(!isDuplicatePill( $(this) )){
				$('#form-pillbox ul').append('<li class="status-success" data-type="' + $(this).attr("data-type") + '" data-value="' + $(this).attr("data-value") + '">' + $(this).attr("value") + '</li>');
			}
		});
		
		$('.form-button').click(function () {
			if(!isDuplicatePill( $(this) )){
				$('#form-pillbox ul').append('<li class="status-success" data-type="' + $(this).attr("data-type") + '" data-value="' + $(this).attr("data-value") + '">' + $(this).attr("value") + '</li>');
			}
		});

		$('.form-titre').keypress(function(event){
			var value = $(this).attr("value").trim();
			if( event.which == 13 && value != "" ){
				$(this).attr("data-value", value);
				if(!isDuplicatePill( $(this) )){
					$('#form-pillbox ul').append('<li class="status-success" data-type="' + $(this).attr("data-type") + '" data-value="' + $(this).attr("data-value") + '">' + value + '</li>');
				}
				$(this).attr("value", "");
				$(this).attr("data-value", "");
				event.preventDefault();
			}
		});
		
		function isDuplicatePill(el){
			var duplicate = false;
			jQuery.each($('#form-pillbox').pillbox('items'), function() {
				if(this.value === $(el).attr("data-value") && this.type === $(el).attr("data-type")){
					duplicate = true;
					return;
				}
			});
			return duplicate;
		}

		/*$('#form-switch-titre').click(function () {
			$('#form-titre').attr('placeholder', 'Titre et description');
		});*/
		
	//});
</script>
