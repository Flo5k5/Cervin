<?php
$title = 'Sémantiques des relations entre artefacts';
$this->headTitle($title);

$this->headLink()->prependStylesheet($this->basePath() . '/css/bootstrap-editable.css');
$this->headLink()->prependStylesheet($this->basePath() . '/css/datatable.css');
?>
<?php $this->headLink()->prependStylesheet($this->basePath() . '/css/pillbox.css'); ?>

<!-- Help Modal -->
<div id="helpModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
	    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
	    <h3 id="myModalLabel">Aide : gestion des sémantiques</h3>
    </div>
    <div class="modal-body">
    	<p>
    	Dans la collection numérique, un artefact peut être reliés à plusieurs autres artefacts. Chaque relation doit être porteuse d'une sémantique, petit texte qui explique la logique de cette relation.
    	</p>
    	<p>
    	Pour avoir des sémantiques cohérentes, ces dernières sont prédéfinies et vous pouvez les gérer sur cette page en tant qu'administrateur de l'application.
    	Lorsqu'un utilisateur décidera de lier deux artefacts entre eux, il aura a choisir une sémantique parmis celle existantes.
    	</p>
    	<p>
    	Une sémantique dépend des types d'artefacts que l'ont relie. Vous pouvez ici modifier ou supprimer une sémantique existante, et en créer de nouvelles.
    	</p>
    </div>
    <div class="modal-footer">
	    <button class="btn" data-dismiss="modal" aria-hidden="true">Retour</button>
    </div>
</div>

<div class="page-header row-fluid">
	<div class="span9">
		<h1><?php echo $this->escapeHtml($title); ?> 
	    <small> <a href="#helpModal" data-toggle="modal"><i class="icon-info-sign"> </i></a></small> </h1>
	</div>
	<a href="<?php echo $this->url('semantique/ajouter') ;?>" class="btn btn-primary span3"><i class="icon-plus"></i> Ajouter une sémantique</a>
</div>

<div class="well">
<h3>Recherche</h3>
<form id="form-multi" name="form-multi" class="">
    <div class="row-fluid">
    
        <div class="span6 input-append">
            <input class="form-titre span10" type="text" placeholder="Titre" data-type="titre" />
            <button class="btn btn-info form-plus-titre" type="button"><i class="icon-plus"> </i></button>
        </div>

        <div class="span3">
            <div class="input-prepend input-append">
                <span class="add-on"><i class="icon-tag"> </i></span>
                <select class="form-type span9">
                    <option class="type-all" data-type="type_origine" data-value="type_origine" >Tous types d'origines</option>
                    <?php 
                        foreach ($TypesOrigines as $TypeOrigine){
                            echo '<option data-type="type_origine" data-te="type_origine" data-value="'.$TypeOrigine['id'].'" >'.$TypeOrigine['nom'].'</option>';
                        }
                    ?>
                </select>
                <button class="btn btn-success form-plus-type" type="button"><i class="icon-plus"> </i></button>
            </div>
        </div>
        <div class="span3">
            <div class="input-prepend input-append">
                <span class="add-on"><i class="icon-tag"> </i></span>
                <select class="form-type span9">
                    <option class="type-all" data-type="type_destination" data-value="type_destination" >Tous types de destinations</option>
                    <?php 
                        foreach ($TypesDestinations as $TypeDestination){
                            echo '<option data-type="type_destination" data-te="type_destination" data-value="'.$TypeDestination['id'].'" >'.$TypeDestination['nom'].'</option>';
                        }
                    ?>
                </select>
                <button class="btn btn-success form-plus-type" type="button"><i class="icon-plus"> </i></button>
            </div>
        </div>
        
        
    </div> <!-- /row-fluid -->

    <div class="form-actions">
        <div id="form-pillbox" class="pillbox" style="width:100%;">
            <p><strong>Tags :</strong></p> 
            <ul>
            </ul>
        </div>
        <button id="submit" class="btn btn-primary"><i class="icon-search"> </i> Lancer la recherche</button>
        <button class="btn btn-danger form-clear"><i class="icon-remove"> </i> Vider</button>
    </div>

</form>
</div>

<div class="container-fluid">
    <div class="row-fluid">
        <div class="span12">
            <div>
                <table class="table table-striped table-bordered data">
                    <thead>
                        <tr>
                            <th>Type origine</th>
                            <th>Sémantique</th>
                            <th>Type destination</th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5">En cours de téléchargement</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Contiendra la pop-up de confirmation lors d'un clic sur un bouton 'supprimer' -->
<div id="confirmDiv" >
</div>

<?php 
$this->headScript()->appendFile($this->basePath() . '/js/bootstrap-editable.js');
$this->headScript()->appendFile($this->basePath() . '/js/bootstrap-confirm.js');
$this->headScript()->appendFile($this->basePath() . '/js/dataTables.js');
?>
<?php $this->headScript()->appendFile($this->basePath() . '/js/pillbox.js') ;?>

<?php $this->inlineScript()->captureStart() ?>
	var table;
	

    $(function() {

        $("#submit").click( function () {
            table.fnDraw();
            return false;
        });
		
        table = ResultSet.paginate(
            $('.data'),
            {
                "aoColumns": [
                                null,
                                null, 
                                null,
                                { "bSortable": false  }
                             ],
                "iColumns": 4,
                "bAutoWidth": false,
                "bSortClasses":false,
                "bProcessing": true,
                "bServerSide": true,
                "sAjaxSource": "<?php echo $this->url("semantique"); ?>",
                "fnServerData": function ( sSource, aoData, fnCallback, oSettings ) {
                    
                    var data = new Array();
                    
                    <?php if(isset($js_table)){ echo $js_table; }  ?>
                    
                    jQuery.each($('#form-pillbox').pillbox('items'), function() {
                        var item =  new Object();
                        item["type"] = this.type;
                        item["value"] = this.value;
                        item["te"] = this.te;
        
                        data.push(item);
                        
                        if(typeof(this.context) != 'undefined' && this.type != 'type' ){
                            if(!isDuplicate( 'type', this.context, aoData )){
                                var obj =  new Object();
                                obj["type"] = 'type';
                                obj["value"] = this.context;
                                obj["te"] = this.te;
                                console.log(obj);
                                data.push(obj);
                            }
                        }
                    });

                    if (data.length > 0) {
                        aoData.push( { "name": "conditions", "value": JSON.stringify(data) } );
                    }

                    oSettings.jqXHR = $.ajax( {
                        "dataType": 'json',
                        "type": "POST",
                        "url": sSource,
                        "data": aoData,
                        "success": fnCallback
                    });
                },
                "fnDrawCallback": function () {
                	// Modale de confirmation pour la suppression d'un sémantique
                    $(".SupprimerSemantique").click(function(event){
                        var dateURL = $(this).attr('data-url');
                        var dateValue = $(this).attr('data-value');
                        $('#confirmDiv').confirmModal({
                            heading:'Confirmation',
                            body:"Êtes-vous sûr de vouloir supprimer définitivement la sémantique <br> \""+dateValue+"\" ?",
                            callback: function() {
                                $.post(
                                    dateURL,
                                    { name: "supprimer" },
                                    function(response) {
                                    	document.location.reload();
                                        /*$("#data").dataTable().fnDraw();*/
                                    }
                                );
                            }
                        });   
                    });
                    $('.edit').editable({ mode: 'inline', });
                }
            }
        );


        // INITIALIZING PILLBOX
        $('.form-button').click(function () {
            var value = $.trim($(this).attr("data-value"));
            var type = $(this).attr("data-type");
            if(!isDuplicate( type, value )){
                $('#form-pillbox ul').append('<li class="status-success" data-type="' + type + '" data-value="' + value + '" >' + $(this).attr("value") + '</li>');
            }
        }); 
        
        $('.form-plus-type').click(function () {
            var el = $(this).parent().find('.form-type > option:selected')
            var type = el.attr("data-type");
            var value = el.attr("data-value");
            var dataTE = el.attr("data-te");

            
            if(!isDuplicate( type, value )){
                var context = el.parent().children('.type-all').attr("data-value");
                var icon;
                var color;
                if (context == 'type_origine') {
                    icon = '<i class="icon-tag"> </i>';
                    color = 'status-success';
                } else {
                    icon = '<i class="icon-picture"> </i>';
                    color = 'status-warning';
                }
                
                if( el.hasClass('type-all') ){
                    $('#form-pillbox ul > li[data-context="' + context + '"]').remove();
                    $('#form-pillbox ul').append('<li class="' + color + ' type-all" data-type="' + type + '" data-value="' + value + '" data-te="' + dataTE + '" >' + icon + ' ' + el.val() + '</li>');
                } else {
                    $('#form-pillbox ul > li[data-context="' + context + '"].type-all ').remove();
                    $('#form-pillbox ul').append('<li class="' + color + '" data-type="' + type + '" data-value="' + value + '" data-te="' + dataTE + '">' + icon + ' ' + el.val() + '</li>');
                }
            }

            $(this).parent().children('.form-type').prop('selectedIndex',0);

        }); 
        
        $('.form-plus-titre').click(function () {
            var e = jQuery.Event("keypress");
            e.which = 13; // Code touche entr�e = 13
            $(this).parent().children('.form-titre').trigger(e);
        }); 

        $('.form-titre').keypress(function(event){
            var value = $.trim($(this).attr("value"));
            var type = $(this).attr("data-type");
            if( event.which == 13 && value != "" ){ // Code touche entr�e = 13
                $(this).attr("data-value", value);
                if(!isDuplicate( type, value )){
                    $('#form-pillbox ul').append('<li class="status-info" data-type="' + type + '" data-value="' + value + '">' + '"' + value + '"' + '</li>');
                }
                $(this).attr("value", "");
                $(this).attr("data-value", "");
                event.preventDefault();
            }
        });

        $('.form-clear').click(function () {
            $('.form-titre').attr("value", "").attr("data-value", "");
            $('.form-type').prop('selectedIndex',0);
            $('#form-pillbox ul > li').remove();
            return false;
        });

        function isDuplicate(type, value, array){
            var array = ( typeof(array) == 'undefined' ? $('#form-pillbox').pillbox('items') : array );
            var duplicate = false;
            jQuery.each(array, function() {
                if(this.value == value && this.type == type){
                    duplicate = true;
                    return;
                }
            });
            return duplicate;
        }
        
        String.prototype.ucFirst = function() {
            return this.charAt(0).toUpperCase() + this.slice(1);
        }

	});
<?php $this->inlineScript()->captureEnd() ?>
